#include <stdint.h>
#include <stddef.h>
#include "CheckSum.h"


#define CRC16_POLY   0xA001  // reversed 0x8005
#define CRC16_INIT   0x0000

static const uint16_t crc16_table[256] = {
    0x0000, 0xA001, 0xC003, 0x6002, 0xC007, 0x6006, 0x0004, 0xA005,
    0xC00F, 0x600E, 0x000C, 0xA00D, 0x0008, 0xA009, 0xC00B, 0x600A,
    0xC01F, 0x601E, 0x001C, 0xA01D, 0x0018, 0xA019, 0xC01B, 0x601A,
    0x0010, 0xA011, 0xC013, 0x6012, 0xC017, 0x6016, 0x0014, 0xA015,
    0xC03F, 0x603E, 0x003C, 0xA03D, 0x0038, 0xA039, 0xC03B, 0x603A,
    0x0030, 0xA031, 0xC033, 0x6032, 0xC037, 0x6036, 0x0034, 0xA035,
    0x0020, 0xA021, 0xC023, 0x6022, 0xC027, 0x6026, 0x0024, 0xA025,
    0xC02F, 0x602E, 0x002C, 0xA02D, 0x0028, 0xA029, 0xC02B, 0x602A,
    0xC07F, 0x607E, 0x007C, 0xA07D, 0x0078, 0xA079, 0xC07B, 0x607A,
    0x0070, 0xA071, 0xC073, 0x6072, 0xC077, 0x6076, 0x0074, 0xA075,
    0x0060, 0xA061, 0xC063, 0x6062, 0xC067, 0x6066, 0x0064, 0xA065,
    0xC06F, 0x606E, 0x006C, 0xA06D, 0x0068, 0xA069, 0xC06B, 0x606A,
    0x0040, 0xA041, 0xC043, 0x6042, 0xC047, 0x6046, 0x0044, 0xA045,
    0xC04F, 0x604E, 0x004C, 0xA04D, 0x0048, 0xA049, 0xC04B, 0x604A,
    0xC05F, 0x605E, 0x005C, 0xA05D, 0x0058, 0xA059, 0xC05B, 0x605A,
    0x0050, 0xA051, 0xC053, 0x6052, 0xC057, 0x6056, 0x0054, 0xA055,
    0xC0FF, 0x60FE, 0x00FC, 0xA0FD, 0x00F8, 0xA0F9, 0xC0FB, 0x60FA,
    0x00F0, 0xA0F1, 0xC0F3, 0x60F2, 0xC0F7, 0x60F6, 0x00F4, 0xA0F5,
    0x00E0, 0xA0E1, 0xC0E3, 0x60E2, 0xC0E7, 0x60E6, 0x00E4, 0xA0E5,
    0xC0EF, 0x60EE, 0x00EC, 0xA0ED, 0x00E8, 0xA0E9, 0xC0EB, 0x60EA,
    0x00C0, 0xA0C1, 0xC0C3, 0x60C2, 0xC0C7, 0x60C6, 0x00C4, 0xA0C5,
    0xC0CF, 0x60CE, 0x00CC, 0xA0CD, 0x00C8, 0xA0C9, 0xC0CB, 0x60CA,
    0xC0DF, 0x60DE, 0x00DC, 0xA0DD, 0x00D8, 0xA0D9, 0xC0DB, 0x60DA,
    0x00D0, 0xA0D1, 0xC0D3, 0x60D2, 0xC0D7, 0x60D6, 0x00D4, 0xA0D5,
    0x0080, 0xA081, 0xC083, 0x6082, 0xC087, 0x6086, 0x0084, 0xA085,
    0xC08F, 0x608E, 0x008C, 0xA08D, 0x0088, 0xA089, 0xC08B, 0x608A,
    0xC09F, 0x609E, 0x009C, 0xA09D, 0x0098, 0xA099, 0xC09B, 0x609A,
    0x0090, 0xA091, 0xC093, 0x6092, 0xC097, 0x6096, 0x0094, 0xA095,
    0xC0BF, 0x60BE, 0x00BC, 0xA0BD, 0x00B8, 0xA0B9, 0xC0BB, 0x60BA,
    0x00B0, 0xA0B1, 0xC0B3, 0x60B2, 0xC0B7, 0x60B6, 0x00B4, 0xA0B5,
    0x00A0, 0xA0A1, 0xC0A3, 0x60A2, 0xC0A7, 0x60A6, 0x00A4, 0xA0A5,
    0xC0AF, 0x60AE, 0x00AC, 0xA0AD, 0x00A8, 0xA0A9, 0xC0AB, 0x60AA
};

uint16_t crc16_table_calc(const uint8_t *data, size_t length) {
    uint16_t crc = CRC16_INIT;
    for (size_t i = 0; i < length; i++) {
        uint8_t tbl_idx = (crc ^ data[i]) & 0xFF;
        crc = (crc >> 8) ^ crc16_table[tbl_idx];
    }
    return crc;
}

uint16_t checksum(uint8_t* myData,uint8_t size) {
    uint16_t crc = crc16_table_calc(myData, size);
    // printf("CRC-16: 0x%04X\n", crc);
    uart_log_printf("CRC: %04X\r\n", crc);

    return crc;
}